<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mako Shark Tracking Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>/* existing styles here (unchanged) */</style>
</head>
<body>
  <header>Mako Shark Tracking Map – Montauk Shark Lab</header>
  <div id="map"></div>
  <footer>Tracking data by Wildlife Computers</footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>
  <script>
    const sharkInfo = {
      "20U0741": { nickname: "Bolt", species: "Shortfin Mako", size: "210 cm" },
      "22U1749": { nickname: "Riptide", species: "Blue Shark", size: "185 cm" },
      "24U2943": { nickname: "Newcomer", species: "Mako", size: "200 cm" }
    };

    const colors = [
      "#e6194b","#3cb44b","#ffe119","#4363d8",
      "#f58231","#911eb4","#46f0f0","#f032e6",
      "#bcf60c","#fabebe","#008080","#e6beff"
    ];

    const map = L.map("map").setView([38, -70], 5);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:18, attribution:"© OpenStreetMap"}).addTo(map);

    const trackLayers = {};
    const colorMap = {};

    omnivore.kml("https://raw.githubusercontent.com/Myles-Crespin/live-map-site/main/myles-kml.kml")
      .on("ready", function() {
        console.log("KML loaded:", this.getLayers().length, "layers");

        const pointsByTag = {};

        this.eachLayer(layer => {
          const f = layer.feature;
          if (!f || !f.geometry) return;
          const props = f.properties || {};
          const rawName = props.Name || props.name || "";

          const match = rawName.match(/\b[0-9]{2}U[0-9]{4}\b/);
          if (!match) return;

          const tag = match[0];
          if (!pointsByTag[tag]) pointsByTag[tag] = [];

          if (f.geometry.type === "Point") {
            const [lon, lat] = f.geometry.coordinates;
            pointsByTag[tag].push({ coords: [lat, lon], t: props.Start || rawName });
          } else if (f.geometry.type === "LineString") {
            f.geometry.coordinates.forEach(([lon,lat]) => {
              pointsByTag[tag].push({ coords: [lat, lon], t: props.Start || rawName });
            });
          }
        });

        let idx = 0;
        for (const tag in pointsByTag) {
          const pts = pointsByTag[tag];
          if (!pts.length) continue;

          colorMap[tag] = colors[idx % colors.length];
          idx++;

          const latlngs = pts.sort((a,b)=>new Date(a.t)-new Date(b.t)).map(p=>p.coords);
          const pl = L.polyline(latlngs, { color: colorMap[tag], weight:4, opacity:0.9 });
          const info = sharkInfo[tag];
          pl.bindPopup(info 
            ? `<b>${info.nickname}</b><br>Species: ${info.species}<br>Size: ${info.size}<br>Tag: ${tag}` 
            : `Tag: ${tag}`);

          trackLayers[tag] = pl;
          pl.addTo(map);
        }

        addLegend();

        const group = L.featureGroup(Object.values(trackLayers));
        if (group.getLayers().length) map.fitBounds(group.getBounds());
        else console.warn("No tracks added");
      })
      .on("error", e => console.error("Fail loading KML", e));

    function addLegend() {
      const ctrl = L.control({ position: "bottomright" });
      ctrl.onAdd = () => {
        const d = L.DomUtil.create("div", "legend");
        d.innerHTML = "<b>Shark Tracks</b><br>";
        for (const tag in trackLayers) {
          const color = colorMap[tag];
          const info = sharkInfo[tag];
          const label = info ? `${info.nickname} (${tag})` : tag;
          const el = document.createElement("div");
          el.className = "legend-item";
          el.innerHTML = `<div class="legend-color" style="background:${color}"></div><span>${label}</span>`;
          el.onclick = () => {
            Object.entries(trackLayers).forEach(([id,layer]) =>
              id===tag ? map.addLayer(layer) : map.removeLayer(layer)
            );
            map.fitBounds(trackLayers[tag].getBounds());
          };
          d.appendChild(el);
        }
        return d;
      };
      ctrl.addTo(map);
    }
  </script>
</body>
</html>
